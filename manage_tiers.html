<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evoque - Manage Tiers</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app-content">
        <aside id="sidebar">
            <div class="sidebar-header">
                <img id="creator-avatar-sidebar" src="" alt="Creator Avatar" class="logo">
                <h2 id="creator-name-sidebar">My Hub</h2>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="creator_dashboard.html">Dashboard</a></li>
                    <li><a href="my_supporters.html">My Supporters</a></li>
                    <li><a href="manage_tiers.html">My Tiers</a></li>
                    <li><a href="create_post.html">Create Post</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="dashboard.html" class="btn btn-secondary">Switch to Supporter Space</a>
            </div>
        </aside>

        <main id="main-content">
            <h1>Manage Your Tiers</h1>
            
            <div class="content-section">
                <h2>Create a New Tier</h2>
                <form id="create-tier-form">
                    <div class="form-group">
                        <label for="tier-name">Tier Name (e.g., Bronze, Silver, Gold)</label>
                        <input type="text" id="tier-name" required>
                    </div>
                    <div class="form-group">
                        <label for="tier-price">Monthly Price (in π)</label>
                        <input type="number" id="tier-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="tier-description">Benefits & Description (one per line)</label>
                        <textarea id="tier-description" rows="5" required placeholder="Exclusive content&#10;Early access to videos&#10;Special Discord role"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Tier</button>
                    <p id="form-status"></p>
                </form>
            </div>

            <div class="content-section">
                <h2>Your Existing Tiers</h2>
                <div id="existing-tiers-list">
                    <p>Loading your tiers...</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Standard login check and Firebase init
            const piUserString = sessionStorage.getItem('piUser');
            if (!piUserString) { window.location.href = 'index.html'; return; }
            const piUser = JSON.parse(piUserString);

            // **IMPORTANT**: PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
        const firebaseConfig = {
            apiKey: "AIzaSyAJpReP6wVK925owZPC2U3J-Lv1fT7QKI4",
            authDomain: "evoque-app.firebaseapp.com",
            projectId: "evoque-app",
            storageBucket: "evoque-app.firebasestorage.app",
            messagingSenderId: "790735748571",
            appId: "1:790735748571:web:1938b35b04ef1c3a92fbfe",
            measurementId: "G-DG6WWPYQ3Z"
        };
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            const db = firebase.firestore();

            const creatorDocRef = db.collection('creators').doc(piUser.uid);
            const tiersCollectionRef = creatorDocRef.collection('tiers');

            // Function to fetch and display existing tiers
            async function loadTiers() {
                const tierListDiv = document.getElementById('existing-tiers-list');
                tierListDiv.innerHTML = ''; // Clear list
                const snapshot = await tiersCollectionRef.orderBy('price').get();

                if (snapshot.empty) {
                    tierListDiv.innerHTML = '<p>You have not created any tiers yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const tier = doc.data();
                    const tierElement = document.createElement('div');
                    tierElement.className = 'tier-item'; // We will need to style this
                    tierElement.innerHTML = `
                        <h3>${tier.name} - ${tier.price} π/month</h3>
                        <ul>${tier.description.split('\\n').map(b => `<li>${b}</li>`).join('')}</ul>
                    `;
                    tierListDiv.appendChild(tierElement);
                });
            }

            // Handle new tier form submission
            const createTierForm = document.getElementById('create-tier-form');
            const formStatus = document.getElementById('form-status');
            createTierForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                formStatus.textContent = 'Creating tier...';
                
                const newTier = {
                    name: document.getElementById('tier-name').value,
                    price: parseFloat(document.getElementById('tier-price').value),
                    description: document.getElementById('tier-description').value.replace(/\\n/g, '\\\\n'),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await tiersCollectionRef.add(newTier);
                    formStatus.textContent = 'Tier created successfully!';
                    createTierForm.reset();
                    loadTiers(); // Refresh the list of tiers
                } catch (error) {
                    console.error("Error creating tier: ", error);
                    formStatus.textContent = 'Error creating tier. Please try again.';
                }
            });

            // Initial load of tiers when page opens
            loadTiers();
        });
    </script>
</body>
</html>
