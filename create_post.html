<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evoque - Create Post</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app-content" class="sidebar-collapsed">
        <aside id="sidebar">
            <div class="sidebar-header">
                <img id="creator-avatar-sidebar" src="images/evoque-logo.png" alt="Creator Avatar" class="logo">
                <h2 id="creator-name-sidebar">My Hub</h2>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="creator_dashboard.html">Dashboard</a></li>
                    <li><a href="my_supporters.html">My Supporters</a></li>
                    <li><a href="manage_tiers.html">My Tiers</a></li>
                    <li><a href="create_post.html">Create Post</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="dashboard.html" class="btn btn-secondary">Switch to Supporter Space</a>
            </div>
        </aside>

        <main id="main-content">
            <button id="sidebar-toggler"><span></span></button> 
            <h1>Create a New Post</h1>
            
            <form id="create-post-form">
                <div class="form-group">
                    <label for="post-title">Post Title</label>
                    <input type="text" id="post-title" required>
                </div>
                <div class="form-group">
                    <label for="post-content">Content</label>
                    <textarea id="post-content" rows="10" required></textarea>
                </div>
                <div class="form-group">
                    <label>Who can see this post?</label>
                    <div id="tier-access-options">
                        <p>Loading your tiers...</p>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Publish Post</button>
                <p id="form-status"></p>
            </form>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
    async function initCreatePost(db, piUser) {
        const piUser = JSON.parse(sessionStorage.getItem('piUser'));
            const creatorDocRef = db.collection('creators').doc(piUser.uid);
            const tiersCollectionRef = creatorDocRef.collection('tiers');
            const postsCollectionRef = creatorDocRef.collection('posts');

            // --- Fetch Tiers to Create Access Options ---
            const tierOptionsDiv = document.getElementById('tier-access-options');
            try {
                const snapshot = await tiersCollectionRef.orderBy('price').get();
                tierOptionsDiv.innerHTML = ''; // Clear loading message

                if (snapshot.empty) {
                    tierOptionsDiv.innerHTML = '<p>You must create at least one tier before you can create a post.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const tier = doc.data();
                        const option = document.createElement('div');
                        option.className = 'checkbox-group';
                        option.innerHTML = `
                            <input type="checkbox" id="${doc.id}" name="tiers" value="${doc.id}">
                            <label for="${doc.id}">${tier.name} (${tier.price} Ï€/month)</label>
                        `;
                        tierOptionsDiv.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error fetching tiers: ", error);
                tierOptionsDiv.innerHTML = '<p>Could not load your tiers. Please refresh.</p>';
            }

            // --- Handle Form Submission ---
            const createPostForm = document.getElementById('create-post-form');
            const formStatus = document.getElementById('form-status');
            createPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                formStatus.textContent = 'Publishing post...';

                const selectedTiers = [];
                document.querySelectorAll('input[name="tiers"]:checked').forEach(checkbox => {
                    selectedTiers.push(checkbox.value);
                });

                if (selectedTiers.length === 0) {
                    formStatus.textContent = 'Please select at least one tier for access.';
                    return;
                }

                const newPost = {
                    title: document.getElementById('post-title').value,
                    content: document.getElementById('post-content').value,
                    accessibleTiers: selectedTiers,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await postsCollectionRef.add(newPost);
                    formStatus.textContent = 'Post published successfully!';
                    createPostForm.reset();
                    setTimeout(() => formStatus.textContent = '', 3000);
                } catch (error) {
                    console.error("Error creating post: ", error);
                    formStatus.textContent = 'Error publishing post. Please try again.';
                }
             }
        }
     </script>
     <script src="main.js"></script>
</body>
</html>
