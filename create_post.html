<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evoque - Create Post</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app-content" class="sidebar-collapsed">
        <aside id="sidebar">
            <div class="sidebar-header">
                <img id="creator-avatar-sidebar" src="" alt="Creator Avatar" class="logo">
                <h2 id="creator-name-sidebar">My Hub</h2>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="creator_dashboard.html">Dashboard</a></li>
                    <li><a href="my_supporters.html">My Supporters</a></li>
                    <li><a href="manage_tiers.html">My Tiers</a></li>
                    <li><a href="create_post.html" class="active">Create Post</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="dashboard.html" class="btn btn-secondary">Switch to Supporter Space</a>
                <div id="user-profile">
                    <p>Connected as: <strong id="username-display"></strong></p>
                </div>
            </div>
        </aside>
        <main id="main-content">
            <button id="sidebar-toggler"><span></span></button>
            <h1>Create a New Post</h1>
            <form id="create-post-form">
                <div class="form-group">
                    <label for="post-title">Post Title</label>
                    <input type="text" id="post-title" required>
                </div>
                <div class="form-group">
                    <label for="post-content">Content</label>
                    <textarea id="post-content" rows="10" required></textarea>
                </div>
                <div class="form-group">
                    <label>Who can see this post?</label>
                    <div id="tier-access-options">
                        <p>Loading your tiers...</p>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Publish Post</button>
                <p id="form-status"></p>
            </form>
        </main>
    </div>

    <script type="module">
    async function initCreatePost({ db, piUser, collection, doc, addDoc, getDocs, query, orderBy, serverTimestamp }) {
        if (!piUser || !piUser.uid) { window.location.href = 'index.html'; return; }
        const creatorDocRef = doc(db, 'creators', piUser.uid);
        const tiersCollectionRef = collection(creatorDocRef, 'tiers');
        const postsCollectionRef = collection(creatorDocRef, 'posts');

        const docSnap = await getDoc(creatorDocRef);
        if (docSnap.exists()) {
            const creatorData = docSnap.data();
            document.getElementById('creator-name-sidebar').textContent = creatorData.name;
            document.getElementById('creator-avatar-sidebar').src = creatorData.profileImage;
        }
        
        const tierOptionsDiv = document.getElementById('tier-access-options');
        try {
            const q = query(tiersCollectionRef, orderBy('price'));
            const snapshot = await getDocs(q);
            tierOptionsDiv.innerHTML = '';
            if (snapshot.empty) { tierOptionsDiv.innerHTML = '<p>Create a tier first.</p>'; } 
            else {
                snapshot.forEach(doc => {
                    const tier = doc.data();
                    const option = document.createElement('div');
                    option.className = 'checkbox-group';
                    option.innerHTML = `<input type="checkbox" id="${doc.id}" name="tiers" value="${doc.id}"><label for="${doc.id}">${tier.name}</label>`;
                    tierOptionsDiv.appendChild(option);
                });
            }
        } catch (error) { tierOptionsDiv.innerHTML = '<p>Could not load tiers.</p>'; }

        const createPostForm = document.getElementById('create-post-form');
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formStatus = document.getElementById('form-status');
            formStatus.textContent = 'Publishing...';
            const selectedTiers = Array.from(document.querySelectorAll('input[name="tiers"]:checked')).map(cb => cb.value);
            if (selectedTiers.length === 0) { formStatus.textContent = 'Select at least one tier.'; return; }
            const newPost = {
                title: document.getElementById('post-title').value,
                content: document.getElementById('post-content').value,
                accessibleTiers: selectedTiers,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(postsCollectionRef, newPost);
                formStatus.textContent = 'Post published!';
                createPostForm.reset();
                setTimeout(() => formStatus.textContent = '', 3000);
            } catch (error) { formStatus.textContent = 'Error publishing post.'; }
        });
    }
</script>
  <script src="main.js" type="module"></script>
</body>
</html>